<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Confeitaria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/delivery.css') }}">

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display+SC:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="background">
        <div class="overlay"></div>
        <div class="content">

            <!-- HEADER -->
            <header class="header">
                <div class="retangulo-rosa">
                    <div class="header-left">
                        <div class="imagem-cupcake"></div>
                        <h1 class="titulo">Confeitaria</h1>
                    </div>

                    <!-- Barra de pesquisa -->
                    <form class="barra-pesquisa" action="{{ url_for('delivery') }}" method="GET">
                        <input type="text" name="q" id="search-input" placeholder="Qual √© o tamanho da sua fome?"
                            value="{{ request.args.get('q', '') }}">
                        <button type="submit">üîç</button>
                    </form>

                    <div class="header-right">
                        <div class="usuario-box">
                            {% if usuario %}
                            <a href="{{ url_for('perfil') }}">
                                <img src="{{ url_for('static', filename='img/usuarios/' + usuario.imagem) }}"
                                    alt="Perfil" class="imagem-user">
                                <span class="status-bola logged-in"></span>
                            </a>
                            {% else %}
                            <a href="{{ url_for('cadastro') }}">
                                <img src="{{ url_for('static', filename='img/user-home.png') }}" alt="Cadastrar"
                                    class="imagem-user">
                                <span class="status-bola"></span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="retangulo-dourado"></div>
            </header>

            <!-- ALERTA -->
            {% if request.args.get('q') and produtos|length == 0 %}
            <script>
                alert('Nenhum produto encontrado para "{{ request.args.get("q") }}"');
            </script>
            {% endif %}

            <!-- PRODUTOS -->
            <main class="produtos-container" id="produtos-container">
                {% for produto in produtos %}
                <div class="card">

                    <!-- Favoritar (opcional) -->
                    <div class="card-top">
                        <span class="fav">‚ô°</span>
                    </div>

                    <!-- Imagem do produto -->
                    {% if produto.imagem %}
                    <img src="{{ url_for('static', filename='img/produtos/' ~ produto.imagem) }}"
                        alt="{{ produto.nome }}" class="card-img">
                    {% else %}
                    <div class="sem-imagem">Sem imagem</div>
                    {% endif %}

                    <!-- Nome -->
                    <h3 class="nome-produto">{{ produto.nome }}</h3>

                    <!-- ‚≠ê Avalia√ß√£o -->
                    <div class="avaliacao">
                        {% for i in range(1, 6) %}
                        {% if i <= produto.media_avaliacao %} <span class="estrela cheia">‚òÖ</span>
                            {% else %}
                            <span class="estrela">‚òÖ</span>
                            {% endif %}
                            {% endfor %}
                            <small class="qtd-avaliacoes">
                                ({{ produto.total_avaliacoes }})
                            </small>
                    </div>

                    <!-- Pre√ßo -->
                    <p class="preco">
                        R$ {{ "%.2f"|format(produto.valor_venda) }}
                    </p>

                    <!-- Bot√£o Carrinho -->
                    <form action="{{ url_for('adicionar_carrinho', id=produto.id) }}" method="POST"
                        class="form-carrinho">
                        <button type="submit" class="btn-carrinho">
                            Adicionar
                        </button>
                    </form>

                </div>

                {% endfor %}
            </main>

        </div>
    </div>

    <!-- JS busca inteligente -->
    <script>
        const input = document.getElementById('search-input');
        const container = document.getElementById('produtos-container');

        input.addEventListener('input', async () => {
            const termo = input.value.trim();

            if (!termo) {
                location.reload();
                return;
            }

            const response = await fetch(`/buscar_produtos?q=${encodeURIComponent(termo)}`);
            const produtos = await response.json();

            container.innerHTML = '';

            produtos.forEach(p => {
                const div = document.createElement('div');
                div.classList.add('card');

                div.innerHTML = `
                    ${p.imagem
                        ? `<img src="/static/img/produtos/${p.imagem}" class="card-img">`
                        : `<div class="sem-imagem">Sem imagem</div>`
                    }
                    <h3>${p.nome}</h3>
                    <p>${p.descricao}</p>
                    <p class="preco">R$ ${p.valor_venda.toFixed(2)}</p>
                    <button>Comprar</button>
                `;

                container.appendChild(div);
            });
        });
    </script>
</body>

</html>