<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cadastro.css') }}">
</head>
<body>

<div class="cadastro-container">
    <h2>Cadastro de Usuário</h2>

    <form method="POST" enctype="multipart/form-data">
        <!-- Foto do usuário -->
        <div class="campo-foto">
            <label for="imagem">Foto de perfil (opcional):</label>
            <input type="file" name="imagem" id="imagem" accept="image/*" onchange="previewImagem(event)">
            <img id="preview" src="{{ url_for('static', filename='img/avatar-logado.png') }}" 
                 alt="Preview" class="preview-img">
        </div>

        <!-- Dados pessoais -->
        <input type="text" name="nome" placeholder="Nome de usuário" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="senha" placeholder="Senha" required>

        <!-- CPF -->
        <input type="text" name="cpf" id="cpf" placeholder="CPF" required oninput="validarCPF()">
        <small id="cpf-feedback" style="color:red;"></small>

        <!-- Endereço -->
        <input type="text" name="cep" id="cep" placeholder="CEP" required>
        <input type="text" name="rua" id="rua" placeholder="Rua" required>
        <input type="text" name="bairro" id="bairro" placeholder="Bairro" required>
        <input type="text" name="cidade" id="cidade" placeholder="Cidade" required>

        <select name="tipo_residencia" id="tipo_residencia" onchange="toggleApartamento()">
            <option value="casa">Casa</option>
            <option value="apartamento">Apartamento</option>
        </select>

        <div id="casa">
            <input type="text" name="numero" placeholder="Número">
        </div>

        <div id="apartamento" style="display:none;">
            <input type="text" name="bloco" placeholder="Bloco">
            <input type="text" name="apartamento" placeholder="Apartamento">
        </div>

        <input type="text" name="complemento" placeholder="Complemento (opcional)">

        <button type="submit">Cadastrar</button>
    </form>

    <p style="text-align:center; margin-top:15px;">
        Já tem conta?
        <a href="{{ url_for('login') }}" style="color:blueviolet; text-decoration:underline;">
            Faça login aqui
        </a>
    </p>
</div>

<script>
/* Toggle casa/apartamento */
function toggleApartamento() {
    const tipo = document.getElementById("tipo_residencia").value;
    document.getElementById("casa").style.display = (tipo === "casa") ? "block" : "none";
    document.getElementById("apartamento").style.display = (tipo === "apartamento") ? "block" : "none";
}

/* Preview da imagem */
function previewImagem(event) {
    const reader = new FileReader();
    reader.onload = () => {
        document.getElementById('preview').src = reader.result;
    };
    if (event.target.files[0]) {
        reader.readAsDataURL(event.target.files[0]);
    }
}

/* Validação de CPF */
function validarCPF() {
    const cpf = document.getElementById("cpf").value.replace(/\D/g, '');
    const feedback = document.getElementById("cpf-feedback");

    if (cpf.length !== 11) {
        feedback.textContent = "";
        return false;
    }

    if (/^(\d)\1{10}$/.test(cpf)) {
        feedback.textContent = "CPF inválido";
        feedback.style.color = "red";
        return false;
    }

    let soma = 0, resto;

    for (let i = 1; i <= 9; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) {
        feedback.textContent = "CPF inválido";
        feedback.style.color = "red";
        return false;
    }

    soma = 0;
    for (let i = 1; i <= 10; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    }
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) {
        feedback.textContent = "CPF inválido";
        feedback.style.color = "red";
        return false;
    }

    feedback.textContent = "CPF válido";
    feedback.style.color = "green";
    return true;
}

/* VIA CEP - CORRIGIDO */
document.addEventListener("DOMContentLoaded", function () {

    const cepInput = document.getElementById("cep");

    cepInput.addEventListener("blur", function () {
        const cep = cepInput.value.replace(/\D/g, '');

        if (cep.length !== 8) return;

        fetch(`http://viacep.com.br/ws/${cep}/json/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erro na requisição");
                }
                return response.json();
            })
            .then(data => {
                if (data.erro) {
                    alert("CEP não encontrado");
                    return;
                }

                document.getElementById("rua").value = data.logradouro || '';
                document.getElementById("bairro").value = data.bairro || '';
                document.getElementById("cidade").value = data.localidade || '';
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao buscar o CEP");
            });
    });

});


</script>

</body>
</html>
